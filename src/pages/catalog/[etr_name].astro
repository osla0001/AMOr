---
//@ts-nocheck
import Layout from "../../layouts/Layout.astro";
import mysql from "mysql2/promise";
import SectionSingleView from "../../components/SectionSingleView.astro";

export async function getStaticPaths() {
  const db = await mysql.createPool({
    host: import.meta.env.DB_HOST || "34.175.101.196",
    port: parseInt(import.meta.env.DB_PORT || "3306"),
    user: import.meta.env.DB_USER || "root",
    password: import.meta.env.DB_PASSWORD || 'MvbsQB4|"Otq$\\d8',
    database: import.meta.env.DB_NAME || "munchmap",
    waitForConnections: true,
    connectionLimit: 10,
    queueLimit: 0,
    connectTimeout: 60000,
    acquireTimeout: 60000,
    timeout: 60000,
  });
  const [rows] = await db.query(`SELECT DISTINCT e.etr_name FROM eatery e`);
  await db.end();

  return (rows as any[]).map((row) => ({
    params: { etr_name: row.etr_name.replace(/\s+/g, "") },
  }));
}

const { etr_name } = Astro.params;
const db = await mysql.createPool({
  host: import.meta.env.DB_HOST || "34.175.101.196",
  port: parseInt(import.meta.env.DB_PORT || "3306"),
  user: import.meta.env.DB_USER || "root",
  password: import.meta.env.DB_PASSWORD || 'MvbsQB4|"Otq$\\d8',
  database: import.meta.env.DB_NAME || "munchmap",
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0,
  connectTimeout: 60000,
  acquireTimeout: 60000,
  timeout: 60000,
});

const [rows] = await db.query(
  `SELECT 
    e.etr_id, e.etr_name, e.etr_coordinates, e.etr_address, e.etr_menu_highlights,
    e.etr_lgbt_friendly, e.etr_women_owned, e.etr_price_range, e.etr_outdoor_seating,
    e.etr_pet_friendly, e.etr_wifi, e.etr_payment_methods, e.etr_local_suppliers,
    e.etr_opening_hours, e.etr_bg_stry, e.etr_phone, e.etr_email,
    c.cus_name
  FROM eatery e
  LEFT JOIN eatery_cuisine ec ON e.etr_id = ec.etrc_etr_id
  LEFT JOIN cuisine c ON ec.etrc_cus_id = c.cus_id
  WHERE REPLACE(e.etr_name, ' ', '') = ?`,
  [etr_name],
);

await db.end();

if (!rows || (rows as any[]).length === 0) {
  return Astro.redirect("/404");
}

const firstRow = (rows as any[])[0];
const cuisines: string[] = [];

(rows as any[]).forEach((row) => {
  if (row.cus_name && !cuisines.includes(row.cus_name)) {
    cuisines.push(row.cus_name);
  }
});

let menuHighlights = [];
try {
  if (firstRow.etr_menu_highlights) {
    menuHighlights = JSON.parse(firstRow.etr_menu_highlights);
  }
} catch (e) {
  console.error("Failed to parse menu highlights:", e);
}

const eatery = {
  id: firstRow.etr_id,
  name: firstRow.etr_name,
  address: firstRow.etr_address || "Ingen adresse",
  cuisines: cuisines.length > 0 ? cuisines.join(", ") : "Ikke angivet",
  menu_highlights: menuHighlights,
  lgbt_friendly: firstRow.etr_lgbt_friendly || false,
  women_owned: firstRow.etr_women_owned || false,
  price_range: firstRow.etr_price_range || "Not specified",
  outdoor_seating: firstRow.etr_outdoor_seating || false,
  pet_friendly: firstRow.etr_pet_friendly || false,
  wifi: firstRow.etr_wifi || false,
  payment_methods: firstRow.etr_payment_methods || "Not specified",
  local_suppliers: firstRow.etr_local_suppliers || false,
  opening_hours: firstRow.etr_opening_hours || "Not available",
  bg_stry: firstRow.etr_bg_stry || "Not available",
  phone: firstRow.etr_phone || "Not available",
  email: firstRow.etr_email || "Not available",
};

const description = `Discover ${eatery.name} in Lisbon. ${eatery.cuisines} restaurant located at ${eatery.address}. ${eatery.bg_stry.substring(0, 100)}...`;
---

<Layout title=`AMOR - ${eatery.name}` description={description}>
  <main>
    <a href="#" class="back-link" id="backLink">
      <svg
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
      Go back
    </a>
    <h2>{eatery.name}</h2>
    <div class="image_container">
      <img
        src={`/eatery/${eatery.id}.webp`}
        alt={eatery.name}
        class="big_img"
      />
    </div>
    <SectionSingleView
      title="DETAILS"
      image={`/eatery/${eatery.id}_1.webp`}
      order="-1"
      hasButton={false}
      aos="fade-right"
      ><b>Kitchen:</b>
      {eatery.cuisines}
      <br />
      <b>Location:</b>
      <a
        href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(eatery.address)}`}
        target="_blank"
        rel="noopener noreferrer">{eatery.address}</a
      >
      <br />
      <b>Contact:</b>
      <a href={`tel:${eatery.phone}`}>{eatery.phone}</a> & <a
        href={`mailto:${eatery.email}`}>{eatery.email}</a
      >
      <br />
      <b>Opening hours:</b>
      {eatery.opening_hours}
    </SectionSingleView>
    <SectionSingleView
      title="ABOUT"
      image={`/eatery/${eatery.id}_2.webp`}
      hasButton={false}
      aos="fade-left"
      >{eatery.bg_stry}
    </SectionSingleView>
    <section class="dishes" data-aos="fade-right">
      <div class="container">
        <div class="center">
          <h2>BEST DISHES</h2>
          <p>
            Every eatery in our database has something special to offer! <br
            />Explore some of the top dishes that make {eatery.name} a must-visit!
          </p>
        </div>
      </div>

      <div class="catalog">
        <div class="catalog-grid">
          {
            eatery.menu_highlights.map((dish: any, index: number) => (
              <div class="dish">
                <img
                  src={`/eatery/${eatery.id}_dish_${index + 1}.webp`}
                  alt={dish.title}
                />
                <p>
                  <b>{dish.title}</b>
                </p>
                <p>{dish.description}</p>
              </div>
            ))
          }
        </div>
      </div>
    </section>
    <section data-aos="fade-left">
      <div class="center">
        <h2>MORE DETAILS</h2>
        <div class="icons">
          <!-- Row 1 -->
          <div class="icon-item">
            <div class="icon-wrapper">
              <svg
                class={eatery.lgbt_friendly ? "icon-active" : "icon-inactive"}
                xmlns="http://www.w3.org/2000/svg"
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="6" cy="6" r="3"></circle>
                <path d="M6 10a4 4 0 0 0-4 4v3h8v-3a4 4 0 0 0-4-4z"></path>
                <circle cx="12" cy="5" r="3"></circle>
                <path d="M12 9a4 4 0 0 0-4 4v4h8v-4a4 4 0 0 0-4-4z"></path>
                <circle cx="18" cy="6" r="3"></circle>
                <path d="M18 10a4 4 0 0 0-4 4v3h8v-3a4 4 0 0 0-4-4z"></path>
              </svg>
            </div>
            <p>LGBT+ Friendly</p>
          </div>

          <div class="icon-item">
            <div class="icon-wrapper">
              <div
                class={eatery.women_owned
                  ? "icon-text icon-active"
                  : "icon-text icon-inactive"}
              >
                <span class="stroke">♀</span>
              </div>
            </div>
            <p>Women Owned</p>
          </div>
          <div class="icon-item">
            <div class="icon-wrapper">
              <div class="icon-text icon-active">€</div>
            </div>
            <p>{eatery.price_range}</p>
          </div>
          <div class="icon-item">
            <div class="icon-wrapper">
              <svg
                class={eatery.outdoor_seating ? "icon-active" : "icon-inactive"}
                xmlns="http://www.w3.org/2000/svg"
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M3 12h18"></path>
                <path d="M5 8h14"></path>
                <path d="M2 8l1 4v7"></path>
                <path d="M22 8l-1 4v7"></path>
                <path d="M12 8v11"></path>
              </svg>
            </div>
            <p>Outdoor Seating</p>
          </div>
          <!-- Row 2 -->
          <div class="icon-item">
            <div class="icon-wrapper">
              <svg
                class={eatery.pet_friendly ? "icon-active" : "icon-inactive"}
                xmlns="http://www.w3.org/2000/svg"
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M12 5c.67 0 1.35.09 2 .26 1.78-2 5.03-2.84 6.42-2.26 1.4.58-.42 7-.42 7 .57 1.07 1 2.24 1 3.44C21 17.9 16.97 21 12 21s-9-3-9-7.56c0-1.25.5-2.4 1-3.44 0 0-1.89-6.42-.5-7 1.39-.58 4.72.23 6.5 2.23A9.04 9.04 0 0 1 12 5z"
                ></path>
                <path d="M9 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"></path>
                <path d="M15 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"></path>
                <path d="M9.2 15.5c.5.5 1.5.5 3 .5s2.5 0 3-.5"></path>
              </svg>
            </div>
            <p>Pet Friendly</p>
          </div>

          <div class="icon-item">
            <div class="icon-wrapper">
              <svg
                class={eatery.wifi ? "icon-active" : "icon-inactive"}
                xmlns="http://www.w3.org/2000/svg"
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M5 12.55a11 11 0 0 1 14.08 0"></path>
                <path d="M1.42 9a16 16 0 0 1 21.16 0"></path>
                <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
                <circle cx="12" cy="20" r="1"></circle>
              </svg>
            </div>
            <p>WiFi</p>
          </div>

          <div class="icon-item">
            <div class="icon-wrapper">
              <svg
                class="icon-active"
                xmlns="http://www.w3.org/2000/svg"
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="2" y="5" width="20" height="14" rx="2"></rect>
                <line x1="2" y1="10" x2="22" y2="10"></line>
              </svg>
            </div>
            <p>{eatery.payment_methods}</p>
          </div>
          <div class="icon-item">
            <div class="icon-wrapper">
              <svg
                class={eatery.local_suppliers ? "icon-active" : "icon-inactive"}
                xmlns="http://www.w3.org/2000/svg"
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"
                ></path>
                <path d="M15 18H9"></path>
                <path
                  d="M19 18h2a1 1 0 0 0 1-1v-3.28a1 1 0 0 0-.684-.948l-1.923-.641a1 1 0 0 1-.578-.579l-1.5-4A1 1 0 0 0 16.382 7H15"
                ></path>
                <circle cx="7" cy="18" r="2"></circle>
                <circle cx="17" cy="18" r="2"></circle>
              </svg>
            </div>
            <p>Local Suppliers</p>
          </div>
        </div>
      </div>
    </section>
  </main>
</Layout>

<style>
  main {
    padding: 2rem;
    max-width: 1000px;
    margin: 0 auto;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.1rem;
    font-family: "Commissioner", sans-serif;
    font-size: 16px;
    margin-bottom: 1rem;
    text-decoration: none;
    color: var(--patty-6);
    position: absolute;
  }

  h2 {
    text-align: center;
  }

  .image_container {
    margin-top: 1rem;
    display: flex;
    justify-content: center;
  }

  .big_img {
    width: 100%;
    height: auto;
    max-height: 500px;
    object-fit: cover;
    margin-top: 1rem;
  }

  .dishes {
    width: 100%;
    box-sizing: border-box;
    padding: 80px 20px;
  }

  .dishes .container {
    max-width: 1000px;
    margin: 0 auto;
    gap: 2rem;
  }

  .dishes img {
    width: 100%;
    height: max-content;
    object-fit: cover;
  }

  .center p {
    margin-bottom: 1rem;
    max-width: 50ch;
    place-self: center;
  }

  .dishes .center {
    display: flex;
    flex-direction: column;
    justify-content: center;
    margin: 0 auto;
    place-self: center;
  }

  .catalog-grid {
    display: flex;
    flex-direction: row;
    gap: 0.5rem;
    padding-bottom: 1rem;
    margin-bottom: 3rem;
    justify-content: center;
  }

  .dish {
    background-color: transparent;
    padding: 10px;
    margin: 5px;
    text-decoration: none;
    color: inherit;
    display: block;
    height: 280px;
    width: 200px;
    min-width: 200px;
    flex-shrink: 0;
  }

  .dish img {
    height: 200px;
    width: 100%;
    object-fit: cover;
    display: block;
  }

  .icons {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 2rem;
    max-width: 800px;
    margin: 2rem auto;
    padding: 1rem;
  }

  .icon-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 0.5rem;
  }

  .icon-wrapper {
    position: relative;
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .icon-wrapper > svg {
    color: var(--patty-base);
  }

  .icon-active {
    color: var(--lettuce-3) !important;
  }

  .icon-inactive {
    color: var(--cheese-6) !important;
    opacity: 0.2;
  }

  .icon-text {
    font-size: 48px;
    font-weight: 900;
    line-height: 1;
  }

  .icon-item p {
    font-size: 0.875rem;
    margin: 0;
    max-width: 120px;
    width: 100%;
    text-align: center;
  }

  .stroke {
    -webkit-text-stroke: 3px;
  }

  @media (max-width: 768px) {
    .icons {
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
      padding: 0.75rem;
    }

    main {
      padding: 0 1rem;
    }

    h2 {
      font-size: 1.8rem;
      margin-top: 1rem;
    }

    .big_img {
      max-height: 300px;
    }

    .dishes {
      padding: 60px 1rem;
    }

    .catalog-grid {
      gap: 0.35rem;
      margin-bottom: 2rem;
    }

    .dish {
      height: 240px;
      width: 170px;
      min-width: 170px;
      padding: 8px;
    }

    .dish img {
      height: 160px;
    }

    .back-link {
      font-size: 0.9rem;
    }
  }

  @media (max-width: 480px) {
    main {
      padding: 0 0.5rem;
    }

    h2 {
      font-size: 1.5rem;
    }

    .big_img {
      max-height: 200px;
    }

    .dishes {
      padding: 40px 0.5rem;
    }

    .dishes .center p {
      font-size: 0.85rem;
    }

    .catalog-grid {
      gap: 0.25rem;
      margin-bottom: 1.5rem;
    }

    .dish {
      height: 200px;
      width: 140px;
      min-width: 140px;
      padding: 6px;
    }

    .dish img {
      height: 130px;
    }

    .dish h5 {
      font-size: 0.9rem;
    }

    .dish p {
      font-size: 0.75rem;
    }

    .icons {
      gap: 1rem;
      padding: 0.5rem;
    }

    .icon-wrapper {
      width: 48px;
      height: 48px;
    }

    .icon-item p {
      font-size: 0.75rem;
    }

    .back-link {
      font-size: 0.85rem;
      margin: 0.5rem 0;
    }
  }
</style>

<script>
  document.getElementById("backLink")?.addEventListener("click", (e) => {
    e.preventDefault();
    if (document.referrer && document.referrer !== window.location.href) {
      window.history.back();
    } else {
      window.location.href = "/catalog";
    }
  });
</script>
