---
//@ts-nocheck
import Index from "../pages/index.astro";
import Button from "./Button.astro";
import IndexCatalogCard from "./IndexCatalogCard.astro";
import mysql from "mysql2/promise";

// Fetch eateries directly from database
let eateries = [];
try {
  const connection = await mysql.createConnection({
    host: "34.175.101.196",
    port: 3306,
    user: "root",
    password: 'MvbsQB4|"Otq$\\d8',
    database: "munchmap",
    connectTimeout: 60000,
  });

  const [rows] = await connection.execute(`
    SELECT 
      e.etr_id as id,
      e.etr_name as name,
      e.etr_address as address,
      c.cus_name
    FROM eatery e
    LEFT JOIN eatery_cuisine ec ON e.etr_id = ec.etrc_etr_id
    LEFT JOIN cuisine c ON ec.etrc_cus_id = c.cus_id
  `);

  await connection.end();

  // Group by restaurant ID to avoid duplicates
  const eateriesMap = new Map();
  (rows as any[]).forEach((row) => {
    if (!eateriesMap.has(row.id)) {
      eateriesMap.set(row.id, {
        id: row.id,
        name: row.name,
        address: row.address,
        cuisines: [],
      });
    }
    if (
      row.cus_name &&
      !eateriesMap.get(row.id).cuisines.includes(row.cus_name)
    ) {
      eateriesMap.get(row.id).cuisines.push(row.cus_name);
    }
  });

  // Convert to array and combine cuisines
  eateries = Array.from(eateriesMap.values()).map((e) => ({
    id: e.id,
    name: e.name,
    address: e.address,
    cus_name: e.cuisines.length > 0 ? e.cuisines.join(", ") : "Not specified",
  }));
} catch (error) {
  console.error("Database connection error:", error);
}
---

<section data-aos="fade-right">
  <div class="container">
    <div class="center">
      <h2>DISCOVER</h2>
      <p>
        The catalog puts the power of choice in your hands. Instead of big
        chains or generic lists, you get local options. Find your new hidden
        gems.
      </p>
    </div>
    <div class="catalog">
      <div class="catalog-grid">
        {
          eateries
            .slice(0, 9)
            .map((eatery) => (
              <IndexCatalogCard
                id={eatery.id}
                name={eatery.name}
                cuisine={eatery.cus_name}
                address={eatery.address}
              />
            ))
        }
      </div>
      <div class="center">
        <Button color="var(--bun-6)" href="/catalog">Open Catalog</Button>
      </div>
    </div>
  </div>
</section>

<style>
  section {
    width: 100%;
    box-sizing: border-box;
    padding: 120px 20px;
  }

  .container {
    max-width: 1000px;
    margin: 0 auto;
    gap: 2rem;
  }

  h2 {
    margin-bottom: 1rem;
    place-self: center;
  }

  img {
    width: 100%;
    height: max-content;
    object-fit: cover;
  }

  p {
    margin-bottom: 1rem;
    max-width: 50ch;
    place-self: center;
  }

  .center {
    display: flex;
    flex-direction: column;
    justify-content: center;
    margin: 0 auto;
    place-self: center;
  }

  .catalog-grid {
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;
    gap: 1.1rem;
    overflow-x: auto;
    overflow-y: hidden;
    padding-bottom: 1rem;
    scroll-behavior: smooth;
    margin-bottom: 3rem;
  }

  .catalog-grid::-webkit-scrollbar {
    height: 8px;
  }

  .catalog-grid::-webkit-scrollbar-track {
    background: var(--bun-2);
    border-radius: 10px;
  }

  .catalog-grid::-webkit-scrollbar-thumb {
    background: var(--ketchup-base);
    border-radius: 10px;
  }

  .catalog-grid::-webkit-scrollbar-thumb:hover {
    background: var(--ketchup-4);
  }

  @media (max-width: 768px) {
    section {
      padding: 60px 1rem;
    }

    h2 {
      font-size: 1.8rem;
    }

    .center {
      text-align: center;
    }

    .catalog-grid {
      gap: 0.75rem;
    }
  }

  @media (max-width: 480px) {
    section {
      padding: 40px 0.75rem;
    }

    h2 {
      font-size: 1.5rem;
    }

    p {
      font-size: 0.9rem;
    }

    .catalog-grid {
      gap: 0.5rem;
      margin-bottom: 2rem;
    }
  }
</style>
